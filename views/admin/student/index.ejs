<!DOCTYPE html>
<html data-theme="HEAP">
  <head>
    <title>Higher Education Access Prediction System</title>
    <link rel="stylesheet" href="/stylesheets/style.css" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <div id="root">
      <div class="drawer">
        <input id="left-sidebar-drawer" type="checkbox" class="drawer-toggle" />
        <div class="drawer-content flex flex-col">
          <% include ../../partial/adminNav %>
          <main class="flex-1 overflow-y-auto md:pt-4 pt-4 px-6 bg-base-200">
            <div class="container mx-auto p-6">
              <h1 class="text-4xl font-bold text-center mb-8">Students List</h1>

              <!-- Filters -->
              <div class="card bg-base-100 shadow-xl mb-6">
                <div class="card-body">
                  <h2 class="card-title mb-4">Search & Filter</h2>
                  <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <input
                      type="text"
                      id="searchInput"
                      placeholder="Search name, regional code, roll no..."
                      class="input input-bordered"
                    />

                    <select id="categoryFilter" class="select select-bordered">
                      <option value="">All Categories</option>
                      <option value="A">Bio</option>
                      <option value="B">Eco</option>
                      <option value="C">ဝိဇ္ဇာ</option>
                    </select>

                    <select id="statusFilter" class="select select-bordered">
                      <option value="">All Status</option>
                      <option value="Pass">Pass</option>
                      <option value="Fail">Fail</option>
                    </select>

                    <select id="genderFilter" class="select select-bordered">
                      <option value="">All Genders</option>
                      <option value="Male">Male</option>
                      <option value="Female">Female</option>
                    </select>

                    <button id="searchBtn" class="btn btn-primary">
                      Search
                    </button>
                  </div>
                </div>
              </div>

              <!-- Results Summary -->
              <div
                class="stats shadow mb-6"
                id="summaryStats"
                style="display: none"
              >
                <div class="stat">
                  <div class="stat-title">Total Students</div>
                  <div class="stat-value" id="totalCount">0</div>
                </div>
                <div class="stat">
                  <div class="stat-title">Current Page</div>
                  <div class="stat-value" id="currentPage">1</div>
                </div>
                <div class="stat">
                  <div class="stat-title">Total Pages</div>
                  <div class="stat-value" id="totalPages">1</div>
                </div>
              </div>

              <!-- Students Table -->
              <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                  <div class="flex justify-between items-center mb-4">
                    <h2 class="card-title">Student Records</h2>
                    <select
                      id="limitSelect"
                      class="select select-bordered select-sm"
                    >
                      <option value="10">10 per page</option>
                      <option value="25">25 per page</option>
                      <option value="50">50 per page</option>
                      <option value="100">100 per page</option>
                    </select>
                  </div>

                  <div id="loadingSpinner" class="flex justify-center py-8">
                    <span class="loading loading-spinner loading-lg"></span>
                  </div>

                  <div id="studentsTable" style="display: none">
                    <div class="overflow-x-auto">
                      <table class="table w-full">
                        <thead>
                          <tr>
                            <th>Roll No</th>
                            <th>Name</th>
                            <th>Regional Code</th>
                            <th>Category</th>
                            <th>Gender</th>
                            <th>Total Mark</th>
                            <th>Status</th>
                            <th>Academic Year</th>
                            <th>Action</th>
                          </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                          <!-- Students will be loaded here -->
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div
                    id="noResults"
                    class="text-center py-8"
                    style="display: none"
                  >
                    <div class="alert alert-info">
                      <span>No students found matching your criteria.</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Pagination -->
              <div class="flex justify-center mt-6">
                <div class="join" id="pagination">
                  <!-- Pagination buttons will be generated here -->
                </div>
              </div>
            </div>
            <dialog id="studentModal" class="modal">
              <div class="modal-box w-11/12 max-w-2xl">
                <h3 class="font-bold text-lg mb-4">Student Details</h3>
                <div id="studentDetails">
                  <!-- Student details will be loaded here -->
                </div>
                <div class="modal-action">
                  <form method="dialog">
                    <button class="btn">Close</button>
                  </form>
                </div>
              </div>
            </dialog>
            <div class="h-16"></div>
          </main>
        </div>
        <% include ../../partial/adminDrawer %>
      </div>
    </div>
  </body>
  <script>
    let currentPage = 1;
    let currentLimit = 10;
    let currentFilters = {};

    // Load students when page loads
    document.addEventListener("DOMContentLoaded", function () {
      loadStudents();

      // Event listeners
      document
        .getElementById("searchBtn")
        .addEventListener("click", handleSearch);
      document
        .getElementById("limitSelect")
        .addEventListener("change", handleLimitChange);

      // Enter key search
      document
        .getElementById("searchInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            handleSearch();
          }
        });
    });

    function handleSearch() {
      currentPage = 1;
      currentFilters = {
        search: document.getElementById("searchInput").value,
        category: document.getElementById("categoryFilter").value,
        status: document.getElementById("statusFilter").value,
        gender: document.getElementById("genderFilter").value,
      };
      loadStudents();
    }

    function handleLimitChange() {
      currentLimit = parseInt(document.getElementById("limitSelect").value);
      currentPage = 1;
      loadStudents();
    }

    async function loadStudents() {
      showLoading();

      try {
        const params = new URLSearchParams({
          page: currentPage,
          limit: currentLimit,
          ...currentFilters,
        });

        const response = await fetch(`/admin/api/students?${params}`);
        const data = await response.json();

        if (data.students) {
          displayStudents(data.students);
          displayPagination(data.pagination);
          updateSummary(data.pagination);
        } else {
          showNoResults();
        }
      } catch (error) {
        console.error("Error loading students:", error);
        showNoResults();
      }
    }

    function showLoading() {
      document.getElementById("loadingSpinner").style.display = "flex";
      document.getElementById("studentsTable").style.display = "none";
      document.getElementById("noResults").style.display = "none";
      document.getElementById("summaryStats").style.display = "none";
    }

    function showNoResults() {
      document.getElementById("loadingSpinner").style.display = "none";
      document.getElementById("studentsTable").style.display = "none";
      document.getElementById("noResults").style.display = "block";
      document.getElementById("summaryStats").style.display = "none";
    }

    function displayStudents(students) {
      const tbody = document.getElementById("studentsTableBody");
      tbody.innerHTML = "";

      students.forEach((student) => {
        const row = document.createElement("tr");
        row.className = "hover";

        // Convert roll number back to Myanmar numerals for display
        const myanmarRollNo = convertToMyanmarNumeral(student.rollNo);

        row.innerHTML = `
                    <td class="font-mono">${myanmarRollNo}</td>
                    <td class="font-semibold">${student.name}</td>
                    <td>${student.regionalCode}</td>
                    <td><span class="badge badge-outline">${
                      student.category === "A"
                        ? "Bio"
                        : student.category === "B"
                        ? "Eco"
                        : "ဝိဇ္ဇာ"
                    }</span></td>
                    <td>${student.gender}</td>
                    <td class="font-mono">${student.totalMark}</td>
                    <td>
                        <span class="badge ${
                          student.status === "Pass"
                            ? "badge-success"
                            : "badge-error"
                        }">
                            ${student.status}
                        </span>
                    </td>
                    <td>${student.academicYear}</td>
                    <td>
                        <button onclick="showStudentDetails('${
                          student._id
                        }')" class="btn btn-sm btn-outline">
                            View Details
                        </button>
                    </td>
                `;
        tbody.appendChild(row);
      });

      document.getElementById("loadingSpinner").style.display = "none";
      document.getElementById("studentsTable").style.display = "block";
    }

    function displayPagination(pagination) {
      const paginationDiv = document.getElementById("pagination");
      paginationDiv.innerHTML = "";

      // Previous button
      if (pagination.hasPrev) {
        const prevBtn = document.createElement("button");
        prevBtn.className = "join-item btn";
        prevBtn.innerHTML = "« Previous";
        prevBtn.onclick = () => changePage(pagination.current - 1);
        paginationDiv.appendChild(prevBtn);
      }

      // Page numbers
      const startPage = Math.max(1, pagination.current - 2);
      const endPage = Math.min(pagination.total, pagination.current + 2);

      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement("button");
        pageBtn.className = `join-item btn ${
          i === pagination.current ? "btn-active" : ""
        }`;
        pageBtn.innerHTML = i;
        pageBtn.onclick = () => changePage(i);
        paginationDiv.appendChild(pageBtn);
      }

      // Next button
      if (pagination.hasNext) {
        const nextBtn = document.createElement("button");
        nextBtn.className = "join-item btn";
        nextBtn.innerHTML = "Next »";
        nextBtn.onclick = () => changePage(pagination.current + 1);
        paginationDiv.appendChild(nextBtn);
      }
    }

    function updateSummary(pagination) {
      document.getElementById("totalCount").textContent =
        pagination.totalStudents;
      document.getElementById("currentPage").textContent = pagination.current;
      document.getElementById("totalPages").textContent = pagination.total;
      document.getElementById("summaryStats").style.display = "flex";
    }

    function changePage(page) {
      currentPage = page;
      loadStudents();
    }

    function convertToMyanmarNumeral(number) {
      const myanmarNumerals = {
        0: "၀",
        1: "၁",
        2: "၂",
        3: "၃",
        4: "၄",
        5: "၅",
        6: "၆",
        7: "၇",
        8: "၈",
        9: "၉",
      };

      return number.toString().replace(/[0-9]/g, function (match) {
        return myanmarNumerals[match];
      });
    }

    async function showStudentDetails(studentId) {
      console.log("Loading student details for ID:", studentId);
      try {
        // Find student in current loaded data or fetch from server
        const response = await fetch(`/admin/api/students`);
        const data = await response.json();
        const student = data.students.find((s) => s._id === studentId);

        if (student) {
          const detailsDiv = document.getElementById("studentDetails");
          detailsDiv.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-bold mb-2">Basic Information</h4>
                                <p><span class="font-semibold my-2">Name: </span> ${
                                  student.name
                                }</p>
                                <p><span class="font-semibold my-2">Regional Code: </span> ${
                                  student.regionalCode
                                }</p>
                                <p><span class="font-semibold my-2">Roll Number: </span> ${convertToMyanmarNumeral(
                                  student.rollNo
                                )}</p>
                                <p><span class="font-semibold my-2">Gender: </span> ${
                                  student.gender
                                }</p>
                                <p><span class="font-semibold my-2">Category: </span> ${
                                  student.category === "A"
                                    ? "Bio"
                                    : student.category === "B"
                                    ? "Eco"
                                    : "ဝိဇ္ဇာ"
                                }</p>
                                <p><span class="font-semibold my-2">Status: </span> 
                                    <span class="badge ${
                                      student.status === "Pass"
                                        ? "badge-success"
                                        : "badge-error"
                                    }">
                                        ${student.status}
                                    </span>
                                </p>
                                <p><span class="font-semibold my-2">Academic Year: </span> ${
                                  student.academicYear
                                }</p>
                            </div>
                            <div>
                                <h4 class="font-bold mb-2">Subject Marks</h4>
                                <div class="space-y-1">
                                    <p><span class="font-semibold">Myanmar:</span> ${
                                      student.myan
                                    }</p>
                                    <p><span class="font-semibold">English:</span> ${
                                      student.eng
                                    }</p>
                                    <p><span class="font-semibold">Mathematics:</span> ${
                                      student.math
                                    }</p>
                                    ${
                                      student.phy > 0
                                        ? `<p><span class="font-semibold">Physics:</span> ${student.phy}</p>`
                                        : ""
                                    }
                                    ${
                                      student.chem > 0
                                        ? `<p><span class="font-semibold">Chemistry:</span> ${student.chem}</p>`
                                        : ""
                                    }
                                    ${
                                      student.bio > 0
                                        ? `<p><span class="font-semibold">Biology:</span> ${student.bio}</p>`
                                        : ""
                                    }
                                    ${
                                      student.eco > 0
                                        ? `<p><span class="font-semibold">Economics:</span> ${student.eco}</p>`
                                        : ""
                                    }
                                    ${
                                      student.hist > 0
                                        ? `<p><span class="font-semibold">History:</span> ${student.hist}</p>`
                                        : ""
                                    }
                                    ${
                                      student.geo > 0
                                        ? `<p><span class="font-semibold">Geography:</span> ${student.geo}</p>`
                                        : ""
                                    }
                                </div>
                                
                            </div>
                            <p class="mt-3 text-center col-span-full border"><span class="font-semibold text-lg">Total Mark:</span> 
                                    <span class="text-lg font-bold text-primary">${
                                      student.totalMark
                                    }</span>
                                </p>
                        </div>
                    `;

          document.getElementById("studentModal").showModal();
        }
      } catch (error) {
        console.error("Error loading student details:", error);
      }
    }
  </script>
</html>
